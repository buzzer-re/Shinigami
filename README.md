# Shinigami
[![Build](https://github.com/buzzer-re/Shinigami/actions/workflows/ci.yml/badge.svg)](https://github.com/buzzer-re/Shinigami/actions/workflows/ci.yml)
[![Release](https://github.com/buzzer-re/Shinigami/actions/workflows/cd.yml/badge.svg)](https://github.com/buzzer-re/Shinigami/actions/workflows/cd.yml)

<figure>
<img src="assets/mascot/shinigami.png" alt="image description" width="30%" height="30%" style="border-radius: 50%;"/>
</figure>


Shinigami is an experimental tool to detect and dump malware implants that are injected via process hollowing. It works by hooking common functions like CreateProcessInternal, WriteProcessMemory, and ResumeThread.

It creates the target executable in a suspended state and injects a DLL library called "Ichigo," which will hook every needed function to detect and dump the implant. The library automatically kills the process once the hollow is extracted.

***Shinigami is a dynamic unpacking tool, so you don't want to run this on your machine or in your static analysis lab***

***The current version only supports Process Hollowing, but I have plans to detect other kinds of unpacking mechanisms for a more general approach.***



## Current detection methods

- ResumeThread
  - By hooking ResumeThread it will hunt inside all the previous allocated memory via `VirtualAllocEx` if contains the DOS header signature, if found the remote PE file will be extracted, patched to have the sections aligned  and saved in disk with the format ***\<executable\>_dumped.bin***.
  
- WriteProcessMemory
  - By hooking WriteProcessMemory it will detect if the executable is trying to write a PE file in the remote process, if so, it will hunt using the `lpBuffer` pointer and extract any PE files found in the executable itself (not the injected), this PE file saved as ***\<executable\>_before_written.bin***.


## Usage

Shinigami is easy to use as it's only supports process hollowing, so no fancy command line here. Simply run `shinigami.exe` with the executable you want to analyze as the first argument, followed by any arguments you want to pass to it.

### Example usage:

|![](assets/screenshots/test.png)|
|:--:|
|Testing against Dridex|

After the extraction is done, the process is killed and you will have (I hope so) the extracted PE:

|![](assets/screenshots/pe.png)|
|:--:|
|Dumped implant|


The detected implant will be dumped following the format described at [detection methods](#current-detection-methods) section


## Installing

Grab your flavor at the [Release](https://github.com/buzzer-re/Shinigami/releases) page.

## Building and hacking 

It would be amazing if you help this project, so if you want here is the dependencies and steps


- Install Visual Studio >= 2019 with the C++ workload.
- Install [Zydis](https://github.com/zyantific/zydis), a fast and lightweight x86/x86-64 disassembler, I recommend use the [vcpkg]
(https://github.com/zyantific/zydis#building-zydis---using-vcpkg) method.
  - Zydis is used to make sure that the api hooking more precise and to ensure that no opcode is lost when copying.
- Open the Shinigami.sln solution file in Visual Studio and build/code the project.

Please open an issue or pull request for any changes you would like to make.

## Conclusion

This cool mascot image was inspired on Bleach and generated by [Dall-E](https://openai.com/product/dall-e-2).

